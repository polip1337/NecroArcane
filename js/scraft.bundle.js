import{G as f,_ as A,I,c as d,o as u,b as n,t as v,F as m,r as w,k as C,w as g,m as S,v as k,a as K,e as B,S as p,$ as M,d as j,u as T}from"./wizrobe.js";import{F as P}from"./filterbox.bundle.js";import{S as U,a as N}from"./spellschool.bundle.js";const b=(e,s,t)=>{if(!f.state.exists(s))return;let l=e[s];e[s]=l?l+t:t},_=e=>{const s={};for(let t=e.length-1;t>=0;t--){const l=e[t];s.gold=(s.gold||0)+300*l.level,O(l.school,l.level,s)}return s},O=(e,s=1,t={})=>{if(Array.isArray(e))for(let l=e.length-1;l>=0;l--)O(e[l],s,t);else e!=null&&(b(t,e+"gem",Math.min(s,5)*s),s<=5?b(t,"codices",s):b(t,"tomes",s=5));return t},F={mixins:[I],data(){return Object.assign({min:0,showList:!1,showKeywords:!1,schools:{},keywords:[],spellsBySearch:null,userSpells:f.state.userSpells,craft:{name:"Crafted Spell",level:0,buy:null}},p.getSubVars("spells"))},created(){const e=this.spells,s={};for(let o=0;o<e.length;o++){const r=e[o];s[r.school]=this.schools[r.school]===!0}this.schools=s;const t=this.allKeywords,l=[];for(let o=0;o<this.keywords.length;o++){const r=this.keywords[o];for(let a in t)if(t[a][r]){l.push(r);break}}this.keywords=l},setup(){return{counter:0}},components:{filterbox:P,spellschool:N,spelllist:U},updated(){this.counter++},methods:{removeSpell(e){this.userSpells.remove(e)},create(){!this.scraftlist||this.scraftlist.length===0||(f.payCost(_(this.scraftlist.toArray())),this.userSpells.create(this.scraftlist.toArray(),f.state,this.craft.name),this.scraftlist.removeAll())},toggleKeywords(){this.showKeywords=p.setSubVar("spells","showKeywords",!this.showKeywords)},toggleAllSchools(){const e=this.spellsBySearch||this.spellsByLevel;let s=!1;for(let t=0;t<e.length;t++)s||(s=!this.schools[e[t].school]);for(let t=0;t<e.length;t++)this.schools[e[t].school]=s;p.setSubVar("spells","schools",this.schools)},getSpellOrder(e){return e.template?e.sortOrder??9999:-9999},searchSpell(e,s){const t=s.split("|");for(let l=0;l<t.length;l++){if(t[l].length==0)continue;const o=t[l].split(" ");let r=!0;for(let a=0;a<o.length;a++){if(o[a].length==0)continue;const h=o[a].replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");if(!this.crawlSpell(e,new RegExp(h,"i"))){r=!1;break}}if(r)return!0}return!1},toggleSchool(e){this.schools[e]=!this.schools[e],p.setSubVar("spells","schools",this.schools)},crawlSpell(e,s){if(e.template)return this.crawlTemplate(e.template,s);const t=e.items;for(let l=0;l<t.length;l++)if(this.crawlSpell(t[l],s))return!0;return!1},crawlTemplate(e,s){if(e.dot&&s.test("buffs")||e.summon&&s.test("summons"))return!0;if(e.cost){for(let t in e.cost)if(this.crawlProperty(t,s))return!0}for(let t in e)if(!(t=="desc"||t=="flavor"||t=="require"||t=="buy"||t=="cost"||t=="need"||t=="needtext")&&this.crawlProperty(e[t],s))return!0;return!1},crawlObject(e,s){for(let t in e)if(this.crawlProperty(t,s)||this.crawlProperty(e[t],s))return!0;return!1},crawlProperty(e,s){const t=typeof e;if(t=="object"||t=="array")return this.crawlObject(e,s);t!="string"&&(e=e.toString());const l=e.split(/\.|=|<|>|!|,|&&|\|\||\(|\)|\+|\-|'/);for(let o=0;o<l.length;o++){const r=l[o];if(!/^[0-9\*\~\%]*$/.test(r)){if(/^[a-zA-Z0-9_ ]*$/.test(r)){const a=f.state.getData(r);if(a){if(s.test(a.name))return!0;continue}}if(s.test(r))return!0}}return!1},testSpellKeywords(e,s){if(!e.template){const t=e.items;for(let l=0;l<t.length;l++)if(this.testSpellKeywords(t[l],s))return!0;return!1}if(!e.keywords)return!1;for(let t=0;t<s.length;t++){const l=s[t];let o=!1;for(let r in e.keywords)o||(o=e.keywords[r].includes(l));if(!o)return!1}return!0},prelimSpell(){let e={};return e.buy=_(this.scraftlist.toArray()),e.name=this.craft.name,e.level=this.scraftlist.used,e}},computed:{canCraft(){return!(this.scraftlist.used>this.scraftlist.max)&&!this.userSpells.full()&&this.scraftlist.used>0&&f.canPay(_(this.scraftlist.toArray()))},scraftlist(){return f.state.scraftlist},minLevel:{get(){return this.min},set(e){this.min=p.setSubVar("spells","min",Number(e))}},varKeywords:{get(){return this.keywords},set(e){this.keywords=p.setSubVar("spells","keywords",e)}},state(){return f.state},spells(){return this.state.filterItems(e=>e.type==="spell"&&!this.locked(e)).sort((e,s)=>this.getSpellOrder(e)-this.getSpellOrder(s))},allKeywords(){const e={type:{damage:!1,recovery:!1,buff:!1,debuff:!1,summon:!1},target:{self:!1,ally:!1,enemy:!1},targets:{single:!1,multiple:!1},delivery:{instant:!1,"over time":!1},special:{explore:!1,resource:!1,weapon:!1,stance:!1}},s=this.spells;for(let t=0;t<s.length;t++){const l=s[t].keywords??{};for(let o in l){const r=e[o]??(e[o]={}),a=l[o];for(let h=0;h<a.length;h++)r[a[h]]=!0}}for(let t in e){const l=e[t];for(let o in l)l[o]||delete l[o];Object.keys(l).length==0&&delete e[t]}return e},spellsByKeywords(){const e=this.spells,s=this.keywords;return!s||s.length==0?e:e.filter(t=>this.testSpellKeywords(t,s))},spellsByLevel(){const e=this.spellsByKeywords,s=this.minLevel;return s?e.filter(t=>!s||t.level.valueOf()===s):e},spellBySchools(){const e=this.spellsBySearch||this.spellsByLevel,s={};let t;const l=e.length;for(let o=0;o<l;o++){let r=e[o],a=r.school;t=s[a]||(s[a]=[]),t.push(r)}return s}}},z={class:"spellcraft"},D={class:"userspells"},E={class:"custSpellList"},G=["onMouseenterCapture"],q={class:"text-entry"},R=["onUpdate:modelValue"],X=["onClick"],Y={class:"lower"},Z={class:"spellControls"},x={class:"inputgroup"},H=["for"],J=["id"],Q={class:"keywordcontainer"},W={class:"keytitle"},$={class:"keywordgroup"},ee=["value","id"],se=["for"],te={class:"buttongroup"},le={class:"bottom"},re={class:"spellbook"},oe={class:"currentCraft"},ne={class:"options"},ie={class:"text-entry"},ae=["id"],ce=["disabled"],ue={key:0,class:"warn-text"};function de(e,s,t,l,o,r){const a=S("filterbox"),h=S("spellschool"),V=S("spelllist");return u(),d("div",z,[n("div",D,[n("div",null,"Custom Spells: "+v(Math.floor(e.userSpells.used)+" / "+Math.floor(e.userSpells.max.value)),1),n("div",E,[(u(!0),d(m,null,w(e.userSpells.items,i=>(u(),d("div",{key:i.id,onMouseenterCapture:B(c=>e.itemOver(c,i),["stop"])},[n("span",q,[g(n("input",{class:"fld-name",type:"text","onUpdate:modelValue":c=>i.name=c},null,8,R),[[k,i.name]])]),n("button",{type:"button",class:"stop",onClick:c=>r.removeSpell(i)},"X",8,X)],40,G))),128))])]),n("div",Y,[n("div",Z,[n("div",x,[C(a,{modelValue:e.spellsBySearch,"onUpdate:modelValue":s[0]||(s[0]=i=>e.spellsBySearch=i),prop:r.searchSpell,items:r.spellsByLevel},null,8,["modelValue","prop","items"]),n("label",{class:"level-lbl",for:e.elmId("level")},"Level",8,H),g(n("input",{class:"level",id:e.elmId("level"),type:"number","onUpdate:modelValue":s[1]||(s[1]=i=>r.minLevel=i),min:"0",size:"5"},null,8,J),[[k,r.minLevel]])]),n("div",Q,[e.showKeywords?(u(!0),d(m,{key:0},w(r.allKeywords,(i,c)=>(u(),d("div",{class:"keywords",key:c,style:M({"min-width":Object.keys(i).length*9+"%"})},[n("div",W,[n("b",null,v(c),1)]),n("div",$,[(u(!0),d(m,null,w(i,(fe,y)=>(u(),d("div",{class:"checks",key:y},[g(n("input",{type:"checkbox",value:y,id:e.elmId("chk"+y),"onUpdate:modelValue":s[2]||(s[2]=L=>r.varKeywords=L)},null,8,ee),[[j,r.varKeywords]]),n("label",{for:e.elmId("chk"+y)},v(y.toTitleCase()),9,se)]))),128))])],4))),128)):K("",!0)]),n("div",te,[n("button",{type:"button",onClick:s[3]||(s[3]=(...i)=>r.toggleKeywords&&r.toggleKeywords(...i))},"Keywords"),n("button",{type:"button",onClick:s[4]||(s[4]=(...i)=>r.toggleAllSchools&&r.toggleAllSchools(...i))},"Toggle Schools")]),n("div",le,[n("div",re,[(u(!0),d(m,null,w(r.spellBySchools,(i,c)=>(u(),T(h,{spells:i,school:c,key:c,isOpen:!e.schools[c],mode:"scraft",onToggleOpen:r.toggleSchool},null,8,["spells","school","isOpen","onToggleOpen"]))),128))])])]),n("div",oe,[n("div",ne,[n("div",ie,[g(n("input",{class:"fld-name",id:e.elmId("spName"),type:"text","onUpdate:modelValue":s[5]||(s[5]=i=>e.craft.name=i)},null,8,ae),[[k,e.craft.name]])]),n("span",{onMouseenterCapture:s[7]||(s[7]=B(i=>e.itemOver(i,this.prelimSpell()),["stop"]))},[n("button",{type:"button",onClick:s[6]||(s[6]=(...i)=>r.create&&r.create(...i)),disabled:!r.canCraft},"Craft",8,ce)],32),r.scraftlist.used>=r.scraftlist.max?(u(),d("span",ue," You are at your power limit. ")):K("",!0)]),C(V,{class:"spelllist",list:r.scraftlist},null,8,["list"])])])])}const me=A(F,[["render",de],["__scopeId","data-v-a7581495"]]);export{me as default};
